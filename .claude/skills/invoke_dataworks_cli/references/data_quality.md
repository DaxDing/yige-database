# DataWorks 数据质量

## 概述

数据质量帮助监控源端数据变更和 ETL 中产生的脏数据，自动拦截问题任务，阻断脏数据向下游蔓延。

## 质量维度

| 维度 | 说明 | 示例规则 |
|------|------|---------|
| **完整性** | 数据是否存在 | 表记录数 > 0 |
| **有效性** | 数据格式是否正确 | 字段非空率 > 95% |
| **准确性** | 数据值是否准确 | 金额字段 >= 0 |
| **唯一性** | 数据是否重复 | 主键唯一 |
| **一致性** | 数据是否一致 | 源表目标表记录数相等 |
| **合理性** | 数据是否合理 | 波动率 < 20% |

## 质量规则

### 内置模板规则

DataWorks 提供 37+ 种内置模板规则：

| 类别 | 规则 |
|------|------|
| 表级规则 | 表行数、表大小、分区数 |
| 字段规则 | 空值率、唯一值数、最大/最小值 |
| 跨表规则 | 数据一致性、记录数对比 |
| 自定义 SQL | 自定义查询结果校验 |

### 规则配置

**路径**：数据质量 → 规则配置 → 新建规则

**配置项**：

| 配置 | 说明 |
|------|------|
| 规则名称 | 唯一标识 |
| 监控对象 | 表/字段 |
| 规则模板 | 选择内置模板或自定义 |
| 阈值设置 | 告警/阻断阈值 |
| 生效范围 | 分区/全表 |

### 自定义 SQL 规则

```sql
-- 检查数据波动
SELECT
  CASE
    WHEN ABS(today_cnt - yesterday_cnt) / yesterday_cnt > 0.2
    THEN 'FAIL'
    ELSE 'PASS'
  END as result
FROM (
  SELECT
    (SELECT COUNT(*) FROM table WHERE ds = '${bizdate}') as today_cnt,
    (SELECT COUNT(*) FROM table WHERE ds = '${bizdate-1}') as yesterday_cnt
)
```

## 监控配置

### 监控粒度

| 粒度 | 说明 |
|------|------|
| 任务级监控 | 绑定到具体任务节点 |
| 表级监控 | 绑定到数据表 |
| 调度级监控 | 按调度周期监控 |

### 告警配置

| 配置 | 选项 |
|------|------|
| 告警方式 | 邮件/短信/钉钉/Webhook |
| 告警级别 | 警告/严重 |
| 阻断策略 | 仅告警/阻断下游 |

### 阻断策略

| 策略 | 行为 |
|------|------|
| **仅告警** | 发送告警，任务继续执行 |
| **阻断下游** | 发送告警，阻止下游任务运行 |

## 智能功能

### 智能阈值

DataWorks 支持基于历史数据自动推荐阈值：

- 分析历史波动规律
- 机器学习预测合理范围
- 自动设置动态阈值

### 规则推荐

根据表结构和数据特征自动推荐规则：

- 主键字段 → 唯一性规则
- 时间字段 → 有效性规则
- 金额字段 → 准确性规则

## 最佳实践

### 核心表监控

```
1. 主键唯一性检查
2. 记录数波动监控（日环比 < 20%）
3. 关键字段空值率监控
4. 数据时效性检查（分区是否产出）
```

### ETL 链路监控

```
源表 → 数据一致性校验 → 目标表
        ↓
    记录数对比
    关键字段校验
```

## 查看质量报告

**路径**：数据质量 → 质量报告

报告内容：
- 规则执行结果
- 历史趋势
- 问题数据采样
- 影响范围分析
