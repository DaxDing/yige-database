# DataWorks 节点上下文参数

## 概述

节点上下文参数用于实现任务节点间的动态数据传递：
- **上游节点**（生产者）：输出参数值
- **下游节点**（消费者）：接收并使用参数值

## 参数传递方式

### 方式一：赋值节点（推荐）

赋值节点自动捕获最后一行输出作为 `outputs` 参数。

**上游配置**：

```sh
# 赋值节点代码
result=$(curl -s https://api.example.com/token)
echo "$result"  # 最后一行自动成为 outputs
```

**下游配置**：

1. 调度配置 → 节点上下文参数 → 节点输入参数
2. 点击「添加参数」
3. 配置：
   - 参数名：`my_token`（自定义）
   - 取值来源：选择上游节点
   - 参数值：`outputs`

**下游代码引用**：

```sh
# Shell 节点
echo "Token: ${my_token}"

# 数据集成节点 Header
{"Authorization": "Bearer ${my_token}"}
```

### 方式二：手动配置输出参数

普通节点需手动配置节点输出参数。

**上游配置**：

1. 调度配置 → 节点上下文参数 → 节点输出参数
2. 添加参数：
   - 参数名：`token`
   - 参数值：常量或变量（如 `${status}`）

**下游配置**：同方式一

## 赋值节点详解

### 支持的语言

| 语言 | outputs 格式 |
|------|-------------|
| Shell | 最后一行 `echo` |
| ODPS SQL | 最后一行 SELECT 结果 |
| Python | 最后一行 `print` |

### Shell 赋值节点

```sh
# 最后一行 echo 的值成为 outputs
echo "single_value"

# 多值：用逗号分隔
echo "value1,value2,value3"
```

下游访问多值：
- `${param}` - 整个数组
- `${param[0]}` - 第一个值
- `${param[1]}` - 第二个值

### ODPS SQL 赋值节点

```sql
-- 最后一行 SELECT 的结果成为 outputs
SELECT max(dt) FROM table_name;
```

### Python 赋值节点

```python
# 最后一行 print 的值成为 outputs
result = "hello"
print(result)
```

## 配置流程图

```
┌─────────────────────────────────────────────────────────────┐
│                     上游赋值节点                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  代码：                                              │    │
│  │  token=$(curl -s .../token)                         │    │
│  │  echo "$token"  ←── 最后一行                        │    │
│  └─────────────────────────────────────────────────────┘    │
│                          │                                   │
│                          ▼                                   │
│            outputs = "t-abc123..." (自动生成)                │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                     下游节点                                  │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  节点输入参数配置：                                   │    │
│  │  ┌──────────┬──────────────┬─────────┐              │    │
│  │  │ 参数名    │ 取值来源      │ 参数值   │              │    │
│  │  ├──────────┼──────────────┼─────────┤              │    │
│  │  │ access_token │ get_token │ outputs │              │    │
│  │  └──────────┴──────────────┴─────────┘              │    │
│  └─────────────────────────────────────────────────────┘    │
│                          │                                   │
│                          ▼                                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  代码引用：                                          │    │
│  │  curl -H "Authorization: Bearer ${access_token}"    │    │
│  │                    ↓                                │    │
│  │  curl -H "Authorization: Bearer t-abc123..."        │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 数据集成节点引用

在数据集成节点中引用上下文参数：

### Header 配置

```json
{
  "Authorization": "Bearer ${access_token}",
  "Content-Type": "application/json"
}
```

### URL 参数

```
https://api.example.com/data?token=${access_token}&date=${bizdate}
```

### Request Body

```json
{
  "page_size": 20,
  "app_token": "${app_token}",
  "filter": {
    "date": "${bizdate}"
  }
}
```

## 常见问题

### Q1: `${outputs.token}` 没有被替换

**原因**：使用了普通 Shell 节点，而不是赋值节点

**解决**：
1. 删除原节点
2. 新建「赋值节点」（Shell 语言）
3. 代码最后一行 `echo` 输出值

### Q2: 下游节点收不到参数值

**检查清单**：

| 检查项 | 正确配置 |
|--------|---------|
| 节点类型 | 上游必须是赋值节点 |
| 依赖关系 | DAG 图中有连线 |
| 输入参数 | 参数值选 `outputs` |
| 运行方式 | 运行整个工作流 |

**常见错误**：
- 单独运行下游节点 → 上游不会执行
- 参数值填了 `token` 而不是 `outputs`
- 上下游没有建立依赖关系

### Q3: 参数只传递给直接下游

**限制**：赋值节点参数只能传递给**直接下游一层**，不支持跨层级传递。

**解决**：如需跨层传递，中间节点也配置为赋值节点，接力传递。

### Q4: 参数值过大报错

**限制**：传递值最大 2MB

**解决**：
- 只传递关键标识（如 ID、Token）
- 大数据通过文件或数据库中转

## 系统内置参数

| 参数 | 说明 | 示例值 |
|------|------|--------|
| `${status}` | 节点运行状态 | success/failure |
| `${bizdate}` | 业务日期 | 20260107 |
| `${cyctime}` | 调度时间 | 20260107000000 |
| `${taskid}` | 任务实例 ID | 123456 |
