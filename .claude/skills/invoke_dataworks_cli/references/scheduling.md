# DataWorks 调度配置

## 调度类型

| 类型 | 说明 | 适用场景 |
|------|------|---------|
| **周期调度** | 按时间周期自动执行 | 日常数据处理 |
| **手动调度** | 手动触发执行 | 临时任务 |
| **补数据** | 重跑历史数据 | 数据修复 |

## 周期调度配置

### 调度周期

| 周期 | cron 表达式示例 | 说明 |
|------|----------------|------|
| 分钟 | `0 */5 * * * ?` | 每 5 分钟 |
| 小时 | `0 0 * * * ?` | 每小时整点 |
| 天 | `0 0 2 * * ?` | 每天凌晨 2 点 |
| 周 | `0 0 2 ? * MON` | 每周一凌晨 2 点 |
| 月 | `0 0 2 1 * ?` | 每月 1 日凌晨 2 点 |

### 调度参数

#### 系统参数

| 参数 | 格式 | 说明 | 示例值 |
|------|------|------|--------|
| `$bizdate` | yyyymmdd | 业务日期（T-1） | 20260106 |
| `$cyctime` | yyyymmddhh24miss | 定时时间 | 20260107020000 |
| `$gmtdate` | yyyymmdd | 当前日期 | 20260107 |
| `${bdp.system.bizdate}` | yyyymmdd | 同 $bizdate | 20260106 |

#### 自定义参数

**常量参数**：
```
env=prod
app_token=xxx
```

**变量参数**：
```
# 动态日期
dt=$[yyyymmdd]
dt_hour=$[yyyymmddhh24]

# 日期偏移
yesterday=$[yyyymmdd-1]
last_month=$[add_months(yyyymmdd,-1)]
```

**时间变量格式**：

| 格式 | 说明 | 示例 |
|------|------|------|
| `$[yyyymmdd]` | 业务日期 | 20260106 |
| `$[yyyy-mm-dd]` | 带分隔符 | 2026-01-06 |
| `$[yyyymmdd+1]` | 加 1 天 | 20260107 |
| `$[yyyymmdd-7]` | 减 7 天 | 20251230 |
| `$[hh24miss]` | 时分秒 | 020000 |

## 依赖配置

### 依赖类型

| 类型 | 说明 | 配置方式 |
|------|------|---------|
| **同周期依赖** | 等待上游同周期完成 | 默认 |
| **跨周期依赖** | 等待上游上一周期完成 | 高级设置 |
| **自依赖** | 等待自己上一周期完成 | 高级设置 |

### 配置依赖关系

**方式一：拖拽连线**

在 DAG 画布中，从上游节点拖拽连线到下游节点。

**方式二：手动配置**

调度配置 → 依赖的上游节点 → 添加

### 依赖策略

| 策略 | 说明 |
|------|------|
| **全部成功** | 所有上游成功才执行（默认） |
| **任一成功** | 任一上游成功即执行 |
| **忽略依赖** | 不等待上游 |

## 工作流配置

### 创建工作流

1. 数据开发 → 业务流程 → 右键新建
2. 添加节点到工作流
3. 配置节点间依赖
4. 设置工作流参数

### 工作流参数

工作流级别的参数，所有节点可共享：

```
# 工作流参数配置
FEISHU_APP_ID=cli_xxx
FEISHU_APP_SECRET=xxx
TARGET_TABLE=raw_data
```

节点引用：`${FEISHU_APP_ID}`

### 工作流触发

| 触发方式 | 说明 |
|---------|------|
| 定时触发 | 按 cron 表达式 |
| 事件触发 | 文件到达、消息等 |
| API 触发 | 调用 OpenAPI |
| 手动触发 | 运维中心操作 |

## 运行方式

### 手动运行

**运行当前节点**：
- 只运行选中节点
- 上游参数需有默认值

**运行工作流**：
- 从起始节点开始
- 按依赖顺序执行

**冒烟测试**：
- 运行节点及其直接上游
- 用于验证单个节点

### 补数据

**操作路径**：运维中心 → 周期任务 → 补数据

**配置项**：

| 配置 | 说明 |
|------|------|
| 业务日期范围 | 要补数据的日期范围 |
| 包含节点 | 要重跑的节点 |
| 并行度 | 同时运行的实例数 |
| 依赖策略 | 是否等待上游 |

## 运维中心

### 查看任务状态

运维中心 → 周期实例

| 状态 | 含义 |
|------|------|
| 等待时间 | 未到调度时间 |
| 等待资源 | 等待执行资源 |
| 运行中 | 正在执行 |
| 成功 | 执行完成 |
| 失败 | 执行出错 |

### 查看日志

点击实例 → 查看运行日志

日志内容：
- 参数替换详情
- 执行命令
- 输出结果
- 错误信息

### 重跑任务

右键实例 → 重跑

选项：
- 重跑当前节点
- 重跑下游节点
- 重跑当前及下游

## 告警配置

### 告警规则

| 触发条件 | 说明 |
|---------|------|
| 运行失败 | 任务执行出错 |
| 运行超时 | 超过预设时间 |
| 未按时完成 | 超过预期完成时间 |

### 告警方式

- 邮件
- 短信
- 钉钉
- 自定义 Webhook

### 配置方式

调度配置 → 调度依赖 → 告警设置
