<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YICE 数据一致性检查</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL@20,400,1" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #f5f6f8;
  --surface: #ffffff;
  --surface-alt: #fafbfc;
  --border: #e8eaed;
  --border-light: #f0f1f3;

  --text-1: #111827;
  --text-2: #4b5563;
  --text-3: #9ca3af;

  --blue: #2563eb;
  --blue-light: #eff6ff;
  --blue-border: #bfdbfe;

  --green: #059669;
  --green-light: #ecfdf5;
  --green-border: #a7f3d0;

  --red: #dc2626;
  --red-light: #fef2f2;
  --red-border: #fecaca;

  --gray: #9ca3af;
  --gray-light: #f9fafb;
  --gray-border: #e5e7eb;

  --amber: #d97706;

  --ui: 'Sora', -apple-system, sans-serif;
  --mono: 'JetBrains Mono', monospace;

  --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 2px 8px rgba(0,0,0,0.06);
  --radius: 10px;
}

html, body { height: 100%; overflow: hidden; }

body {
  background: var(--bg);
  color: var(--text-1);
  font-family: var(--ui);
  -webkit-font-smoothing: antialiased;
}

.icon {
  font-family: 'Material Symbols Rounded';
  font-size: 18px;
  line-height: 1;
  vertical-align: middle;
  font-variation-settings: 'FILL' 1, 'opsz' 20;
}

/* ═══ Shell ═══ */
.shell { display: grid; grid-template-rows: 52px 1fr; height: 100vh; }

/* ═══ Header ═══ */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 28px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
}

.header-left { display: flex; align-items: center; gap: 12px; }

.logo {
  width: 26px; height: 26px;
  background: linear-gradient(135deg, #2563eb, #3b82f6);
  border-radius: 7px;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--mono); font-size: 10px; font-weight: 700; color: #fff;
  box-shadow: 0 2px 8px rgba(37,99,235,0.25);
}

.header-brand {
  font-family: var(--mono); font-size: 13px; font-weight: 700;
  color: var(--text-1); letter-spacing: 2.5px;
}

.header-sep { color: var(--border); font-size: 18px; font-weight: 300; }

.header-page { font-size: 13px; color: var(--text-3); font-weight: 400; }

.header-right {
  font-family: var(--mono); font-size: 11px;
  color: var(--text-3); letter-spacing: 0.3px;
}

/* ═══ Layout ═══ */
.layout {
  display: grid;
  grid-template-columns: 220px 1fr;
  overflow: hidden;
}

/* ═══ Sidebar ═══ */
.sidebar {
  background: var(--surface);
  border-right: 1px solid var(--border);
  padding: 20px 0;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.sidebar-section { font-family: var(--mono); font-size: 10px; font-weight: 600; color: var(--text-3); letter-spacing: 1.5px; padding: 0 20px; margin-bottom: 8px; }

.sidebar-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 20px; cursor: pointer;
  transition: all 0.15s; position: relative;
  margin: 0 8px; border-radius: 8px;
}

.sidebar-item:hover { background: var(--surface-alt); }

.sidebar-item.active {
  background: var(--blue-light);
}

.sidebar-item.active::before {
  content: ''; position: absolute; left: -8px; top: 50%; transform: translateY(-50%);
  width: 3px; height: 20px; border-radius: 0 3px 3px 0;
  background: var(--blue);
}

.sidebar-item.active .s-name { color: var(--blue); font-weight: 600; }
.sidebar-item.active .s-count { color: var(--blue); }

.s-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.s-dot.pass { background: var(--green); }
.s-dot.fail { background: var(--red); }
.s-dot.partial { background: var(--amber); }

.s-name { font-size: 13px; color: var(--text-2); letter-spacing: 0.1px; }
.s-count { margin-left: auto; font-family: var(--mono); font-size: 10px; color: var(--text-3); flex-shrink: 0; }
.s-count.warn { color: var(--red); font-weight: 600; background: var(--red-light); padding: 1px 7px; border-radius: 999px; }
.s-count.ok { color: var(--green); }

.sidebar-gap { height: 1px; background: var(--border-light); margin: 10px 20px; }

/* ═══ Main ═══ */
.main {
  overflow-y: auto;
  padding: 28px 36px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

/* ═══ Stats Row ═══ */
.stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px;
}

.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 18px;
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow: hidden;
}

.stat-card::after {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
}

.stat-card.total::after { background: var(--blue); }
.stat-card.pass::after { background: var(--green); }
.stat-card.fail::after { background: var(--red); }
.stat-card.pending::after { background: var(--gray); }

.stat-label { font-size: 11px; color: var(--text-3); margin-bottom: 6px; letter-spacing: 0.2px; }

.stat-num { font-family: var(--mono); font-size: 26px; font-weight: 700; line-height: 1; }
.stat-num.total { color: var(--text-1); }
.stat-num.pass { color: var(--green); }
.stat-num.fail { color: var(--red); }
.stat-num.pending { color: var(--gray); }

/* ═══ Category Cards (All View) ═══ */
.cat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }

.cat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  transition: box-shadow 0.2s;
}

.cat-card:hover { box-shadow: var(--shadow-md); }

.cat-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border-light);
}

.cat-head-left { display: flex; align-items: center; gap: 10px; }

.cat-icon {
  width: 30px; height: 30px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
}

.cat-icon.note { background: #ede9fe; color: #7c3aed; }
.cat-icon.creative { background: #fce7f3; color: #db2777; }
.cat-icon.repost { background: #fef3c7; color: #d97706; }
.cat-icon.account { background: #d1fae5; color: #059669; }
.cat-icon.keyword { background: #fef9c3; color: #ca8a04; }
.cat-icon.target { background: #ffe4e6; color: #e11d48; }
.cat-icon.task_group { background: #dbeafe; color: #2563eb; }

.cat-icon .icon { font-size: 16px; }

.cat-title { font-size: 14px; font-weight: 600; color: var(--text-1); }

.cat-badges { display: flex; gap: 8px; }

.cat-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 10px; border-radius: 999px;
  font-family: var(--mono); font-size: 11px; font-weight: 600;
}

.cat-badge.pass { background: var(--green-light); color: var(--green); }
.cat-badge.fail { background: var(--red-light); color: var(--red); }
.cat-badge.pending { background: var(--gray-light); color: var(--gray); }

.cat-body {
  display: grid;
  gap: 0;
}

/* ── Base row (参考基准) ── */
.cat-base {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 20px;
  background: var(--surface-alt);
  border-bottom: 1px solid var(--border-light);
}

.cat-base-left { display: flex; align-items: center; gap: 8px; }

.cat-base-label {
  font-size: 10px; font-weight: 600; letter-spacing: 0.5px;
  color: var(--text-3); text-transform: uppercase;
}

.cat-base-num {
  font-family: var(--mono); font-size: 18px; font-weight: 700;
  color: var(--text-1); letter-spacing: -0.5px;
}

.cat-base-nums { display: flex; align-items: center; gap: 16px; }

.cat-base-stat { display: flex; align-items: baseline; gap: 4px; }

.cat-base-stat-label { font-size: 10px; color: var(--text-3); }

.cat-base-stat-num { font-family: var(--mono); font-size: 18px; font-weight: 700; color: var(--text-1); }

.cat-base-stat-num.active { color: var(--blue); }

.cat-base-right { display: flex; align-items: center; gap: 10px; }

.cat-base-ts { font-family: var(--mono); font-size: 11px; color: var(--text-3); }
.cat-base-source { font-size: 11px; color: var(--text-3); letter-spacing: 0.2px; }

/* ── Sub-group header ── */
.cat-subgroup {
  display: flex; align-items: center; justify-content: space-between;
  padding: 7px 20px;
  font-size: 11px; font-weight: 600; color: var(--text-3);
  letter-spacing: 0.3px;
  border-bottom: 1px solid var(--border-light);
  background: var(--surface);
}

.cat-subgroup-total {
  font-family: var(--mono); font-size: 11px; font-weight: 600;
  color: var(--text-2);
}

/* ── Normal check rows ── */
.cat-item {
  display: grid;
  grid-template-columns: 1fr 140px 120px 80px;
  align-items: center;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border-light);
  transition: background 0.1s;
}

.cat-item-ts { font-family: var(--mono); font-size: 11px; color: var(--text-3); text-align: right; }

.cat-item:last-child { border-bottom: none; }
.cat-item:hover { background: var(--surface-alt); }
.cat-item.indent { padding-left: 36px; }

.cat-item-name { font-size: 13px; color: var(--text-2); display: flex; align-items: center; gap: 8px; }

.cat-item-tag {
  font-size: 10px; font-weight: 500;
  color: var(--text-3); background: var(--surface-alt);
  border: 1px solid var(--border);
  padding: 1px 6px; border-radius: 4px;
}

.cat-item-count {
  font-family: var(--mono); font-size: 12px;
  text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 4px;
}

.cat-item-count .actual { font-weight: 600; color: var(--text-1); }
.cat-item-count .sep { color: var(--text-3); font-size: 10px; }
.cat-item-count .expect { color: var(--text-3); }
.cat-item-count.mismatch .actual { color: var(--red); }

.cat-item-status { text-align: right; }

.badge {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 2px 8px; border-radius: 999px;
  font-family: var(--mono); font-size: 10px; font-weight: 600;
}

.badge .icon { font-size: 12px; }

.badge.pass { background: var(--green-light); color: var(--green); border: 1px solid var(--green-border); }
.badge.fail { background: var(--red-light); color: var(--red); border: 1px solid var(--red-border); }
.badge.pending { background: var(--gray-light); color: var(--gray); border: 1px solid var(--gray-border); }


/* ═══ Toolbar ═══ */
.toolbar {
  display: flex; align-items: center; gap: 16px;
  padding: 12px 18px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
}

.toolbar-label { font-size: 12px; color: var(--text-3); white-space: nowrap; }

.toolbar-date {
  font-family: var(--mono); font-size: 13px; font-weight: 500;
  color: var(--text-1); background: var(--surface-alt);
  border: 1px solid var(--border); border-radius: 6px;
  padding: 5px 10px; cursor: pointer; outline: none;
  transition: border-color 0.15s;
}

.toolbar-date:focus { border-color: var(--blue); }

.toolbar-sep { width: 1px; height: 20px; background: var(--border); }

.toolbar-lag { display: flex; align-items: center; gap: 12px; }

.lag-chip {
  display: flex; align-items: center; gap: 5px;
  font-family: var(--mono); font-size: 11px; color: var(--text-2);
}

.lag-dot { width: 6px; height: 6px; border-radius: 50%; }
.lag-dot.realtime { background: #2563eb; }
.lag-dot.offline { background: #d97706; }
.lag-dot.convert { background: #7c3aed; }

.lag-date { font-weight: 600; color: var(--text-1); }

/* ═══ Animation ═══ */
@keyframes enter { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.main > * { animation: enter 0.3s ease-out both; }
.main > *:nth-child(1) { animation-delay: 0.03s; }
.main > *:nth-child(2) { animation-delay: 0.07s; }
.main > *:nth-child(3) { animation-delay: 0.11s; }
.main > *:nth-child(4) { animation-delay: 0.15s; }
.main > *:nth-child(5) { animation-delay: 0.19s; }

.check, .cat-card { animation: enter 0.25s ease-out both; }

/* ═══ Scrollbar ═══ */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.07); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.12); }
</style>
</head>
<body>

<div class="shell">
  <header class="header">
    <div class="header-left">
      <div class="logo">YC</div>
      <span class="header-brand">YICE</span>
      <span class="header-sep">/</span>
      <span class="header-page">数据一致性检查</span>
    </div>
    <div class="header-right" id="clock"></div>
  </header>
  <div class="layout">
    <aside class="sidebar" id="sidebar"></aside>
    <main class="main" id="main"></main>
  </div>
</div>

<script>
/*
 * lag: 业务时间偏移（可选）
 *   0  = 实时，业务日期 = 今日
 *   1  = 离线，业务日期 = T+1（昨日）
 *   2  = 转化，业务日期 = T+2（前日）
 */
const CHECKS = {
  note: {
    label: '笔记', icon: 'description', baseSource: '内容执行表/复用笔记',
    baseValues: { total: 120, active: 20 },
    baseLabels: { first: '执行笔记', second: '复用笔记标记' },
    items: [
      { id: 'note_base', name: '基准', desc: '基准数据一致性', source: 'DWD', lag: 0 },
      { id: 'note_pgy', name: '蒲公英投后数据', desc: '蒲公英平台投后数据', source: 'ODS → DWD', lag: 1, tag: '执行笔记' },
      { id: 'note_xh_15', name: '星河内容组数据（15）', desc: '星河内容组数据', source: 'ODS → DWD', lag: 1, tag: '小红星执行笔记 + 复用笔记标记' },
      { id: 'note_xh_30', name: '星河内容组数据（30）', desc: '星河内容组数据', source: 'ODS → DWD', lag: 1, tag: '小红星执行笔记 + 复用笔记标记' },
      { id: 'note_jd_15', name: '京东内容组数据（15）', desc: '京东内容组数据', source: 'ODS → DWD', lag: 2, tag: '小红盟执行笔记 + 复用笔记标记' },
      { id: 'note_jd_30', name: '京东内容组数据（30）', desc: '京东内容组数据', source: 'ODS → DWD', lag: 2, tag: '小红盟执行笔记 + 复用笔记标记' },
    ]
  },
  task_group: {
    label: '任务组', icon: 'assignment', baseSource: '任务组规划',
    baseValues: { total: 3, active: 1 },
    baseLabels: { first: '小红星任务', second: '小红盟任务' },
    items: [
      { id: 'tg_base', name: '基准', desc: '基准数据一致性', source: 'DWD', lag: 0 },
      { id: 'tg_xh_15', name: '星河任务组数据（15）', desc: '星河任务组数据', source: 'ODS → DWD', lag: 1, tag: '小红星任务' },
      { id: 'tg_xh_30', name: '星河任务组数据（30）', desc: '星河任务组数据', source: 'ODS → DWD', lag: 1, tag: '小红星任务' },
      { id: 'tg_jd_15', name: '京东任务组数据（15）', desc: '京东任务组数据', source: 'ODS → DWD', lag: 2, tag: '小红盟任务' },
      { id: 'tg_jd_30', name: '京东任务组数据（30）', desc: '京东任务组数据', source: 'ODS → DWD', lag: 2, tag: '小红盟任务' },
    ]
  },
  creative: {
    label: '创意', icon: 'palette', baseSource: '批量计划系统',
    baseValues: { total: 200, active: 11 },
    baseLabels: { first: '总创意数', second: '有效创意' },
    items: [
      { id: 'cr_base', name: '基准', desc: '基准数据一致性', source: 'DWD', lag: 0 },
      { id: 'cr_offline', name: '聚光创意层离线报表', desc: '聚光创意层离线报表数据', source: 'ODS → DWD', lag: 1, tag: '有效创意' },
      { id: 'cr_realtime', name: '聚光创意层实时报表', desc: '聚光创意层实时报表数据', source: 'ODS → DWD', lag: 0, tag: '总创意数' },
      { id: 'cr_conv_xh', name: '聚光小红星转化数据', desc: '聚光小红星转化数据', source: 'ODS → DWD', lag: 2, tag: '有效创意' },
      { id: 'cr_conv_jd', name: '聚光小红盟转化数据', desc: '聚光小红盟转化数据', source: 'ODS → DWD', lag: 2, tag: '有效创意' },
    ]
  },
  keyword: {
    label: '关键词', icon: 'key', baseSource: '批量计划系统',
    baseValues: { total: 14, active: 100 },
    baseLabels: { first: '关键词数量', second: '搜索词数量' },
    items: [
      { id: 'kw_base', name: '基准', desc: '基准数据一致性', source: 'DWD', lag: 0 },
      { id: 'kw_realtime', name: '关键词层级实时报表', desc: '关键词层级实时报表数据', source: 'ODS → DWD', lag: 0, tag: '搜索词' },
      { id: 'kw_offline', name: '关键词层级离线报表', desc: '关键词层级离线报表数据', source: 'ODS → DWD', lag: 1, tag: '关键词' },
      { id: 'sw_offline', name: '搜索词层级离线报表', desc: '搜索词层级离线报表数据', source: 'ODS → DWD', lag: 1, tag: '搜索词' },
    ]
  },
  target: {
    label: '定向包', icon: 'target', baseSource: '批量计划系统',
    baseValues: { total: 100, active: 50 },
    baseLabels: { first: '定向包', second: '人群包' },
    items: [
      { id: 'tg_target_base', name: '基准', desc: '基准数据一致性', source: 'DWD', lag: 0 },
      { id: 'tg_target_realtime', name: '定向层级实时报表', desc: '定向层级实时报表数据', source: 'ODS → DWD', lag: 0, tag: '定向包' },
      { id: 'tg_audience', name: '人群包离线报表', desc: '人群包离线报表数据', source: 'ODS → DWD', lag: 1, tag: '人群包' },
    ]
  },
  account: {
    label: '投流账户', icon: 'account_balance', baseSource: '项目列表',
    items: [
      { id: 'ac_base', name: '基准', desc: '基准数据一致性', source: 'DWD', lag: 0 },
      { id: 'ac_daily', name: '投流账户每日流水报表', desc: '投流账户每日流水报表数据', source: 'ODS → DWD', lag: 1 },
    ]
  }
};

const LAG_LABEL = { 0: '实时', 1: '离线', 2: '转化' };

// 根据 lag 计算业务日期：today - lag 天
function bizDate(lag) {
  if (lag == null) return null;
  const d = new Date(); d.setDate(d.getDate() - lag);
  const p = v => String(v).padStart(2, '0');
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
}

const PROJECTS = [
  {
    id: 'p1', name: '兰蔻小黑瓶',
    checks: {
      note_base: { status: 'pass', actual: 1240, expect: 1240, ts: '2026-02-07' },
      note_pgy:  { status: 'pass', actual: 120, expect: 120, ts: '2026-02-07' },
      note_xh_15:   { status: 'pass', actual: 110, expect: 110, ts: '2026-02-06' },
      note_xh_30:   { status: 'pass', actual: 110, expect: 110, ts: '2026-02-06' },
      note_jd_15:   { status: 'pass', actual: 30, expect: 30, ts: '2026-02-06' },
      note_jd_30:   { status: 'pass', actual: 30, expect: 30, ts: '2026-02-06' },
      cr_base:     { status: 'pass', actual: 65, expect: 65, ts: '2026-02-07' },
      cr_offline:  { status: 'fail', actual: 10, expect: 11, ts: '2026-02-07' },
      cr_realtime: { status: 'fail', actual: 193, expect: 200, ts: '2026-02-08' },
      cr_conv_xh:  { status: 'pass', actual: 6, expect: 6, ts: '2026-02-06' },
      cr_conv_jd:  { status: 'pass', actual: 5, expect: 5, ts: '2026-02-06' },
      kw_base:     { status: 'pass', actual: 14, expect: 14, ts: '2026-02-07' },
      kw_realtime: { status: 'pass', actual: 14, expect: 14, ts: '2026-02-08' },
      kw_offline:  { status: 'pass', actual: 14, expect: 14, ts: '2026-02-07' },
      sw_offline:  { status: 'pass', actual: 100, expect: 100, ts: '2026-02-07' },
      tg_target_base:     { status: 'pass', actual: 150, expect: 150, ts: '2026-02-07' },
      tg_target_realtime: { status: 'pass', actual: 100, expect: 100, ts: '2026-02-08' },
      tg_audience:        { status: 'pass', actual: 50, expect: 50, ts: '2026-02-07' },
      rp_base:     { status: 'pass', actual: 320, expect: 320, ts: '2026-02-07' },
      rp_xh:       { status: 'pass', actual: 210, expect: 210, ts: '2026-02-07' },
      rp_jd:       { status: 'pass', actual: 110, expect: 110, ts: '2026-02-07' },
      ac_base:     { status: 'pass', actual: 1, expect: 1, ts: '2026-02-07' },
      ac_daily:    { status: 'pass', actual: 1, expect: 1, ts: '2026-02-07' },
      tg_base:     { status: 'pass', actual: 1, expect: 1, ts: '2026-02-07' },
      tg_xh_15:       { status: 'pass', actual: 1, expect: 1, ts: '2026-02-06' },
      tg_xh_30:       { status: 'pass', actual: 1, expect: 1, ts: '2026-02-06' },
      tg_jd_15:       { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      tg_jd_30:       { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
    }
  },
  {
    id: 'p2', name: '雅诗兰黛DW',
    checks: {
      note_base: { status: 'pass', actual: 2105, expect: 2105, ts: '2026-02-07' },
      note_pgy:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      note_xh_15:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      note_xh_30:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      note_jd_15:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      note_jd_30:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      cr_base:     { status: 'pass', actual: 75, expect: 75, ts: '2026-02-07' },
      cr_offline:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      cr_realtime: { status: 'pass', actual: 0, expect: 0, ts: '2026-02-08' },
      cr_conv_xh:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      cr_conv_jd:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      kw_base:     { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      kw_realtime: { status: 'pass', actual: 0, expect: 0, ts: '2026-02-08' },
      kw_offline:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      sw_offline:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      tg_target_base:     { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      tg_target_realtime: { status: 'pass', actual: 0, expect: 0, ts: '2026-02-08' },
      tg_audience:        { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      rp_base:     { status: 'pass', actual: 580, expect: 580, ts: '2026-02-07' },
      rp_xh:       { status: 'pass', actual: 380, expect: 380, ts: '2026-02-07' },
      rp_jd:       { status: 'pending', actual: 0, expect: 200, ts: '2026-02-07' },
      ac_base:     { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      ac_daily:    { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      tg_base:     { status: 'pass', actual: 1, expect: 1, ts: '2026-02-07' },
      tg_xh_15:       { status: 'pass', actual: 1, expect: 1, ts: '2026-02-06' },
      tg_xh_30:       { status: 'pass', actual: 1, expect: 1, ts: '2026-02-06' },
      tg_jd_15:       { status: 'pending', actual: 0, expect: 0, ts: '2026-02-06' },
      tg_jd_30:       { status: 'pending', actual: 0, expect: 0, ts: '2026-02-06' },
    }
  },
  {
    id: 'p3', name: '科颜氏白泥',
    checks: {
      note_base: { status: 'pass', actual: 680, expect: 680, ts: '2026-02-07' },
      note_pgy:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      note_xh_15:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      note_xh_30:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      note_jd_15:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      note_jd_30:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      cr_base:     { status: 'pass', actual: 35, expect: 35, ts: '2026-02-07' },
      cr_offline:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      cr_realtime: { status: 'pass', actual: 0, expect: 0, ts: '2026-02-08' },
      cr_conv_xh:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      cr_conv_jd:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      kw_base:     { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      kw_realtime: { status: 'pass', actual: 0, expect: 0, ts: '2026-02-08' },
      kw_offline:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      sw_offline:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      tg_target_base:     { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      tg_target_realtime: { status: 'pass', actual: 0, expect: 0, ts: '2026-02-08' },
      tg_audience:        { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      rp_base:     { status: 'pass', actual: 175, expect: 175, ts: '2026-02-07' },
      rp_xh:       { status: 'pass', actual: 120, expect: 120, ts: '2026-02-07' },
      rp_jd:       { status: 'fail', actual: 48, expect: 55, ts: '2026-02-07' },
      ac_base:     { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      ac_daily:    { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      tg_base:     { status: 'pass', actual: 1, expect: 1, ts: '2026-02-07' },
      tg_xh_15:       { status: 'pass', actual: 1, expect: 1, ts: '2026-02-06' },
      tg_xh_30:       { status: 'pass', actual: 1, expect: 1, ts: '2026-02-06' },
      tg_jd_15:       { status: 'fail', actual: 0, expect: 1, ts: '2026-02-06' },
      tg_jd_30:       { status: 'fail', actual: 0, expect: 1, ts: '2026-02-06' },
    }
  },
  {
    id: 'p4', name: '赫莲娜绿宝瓶',
    checks: {
      note_base: { status: 'pass', actual: 390, expect: 390, ts: '2026-02-07' },
      note_pgy:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      note_xh_15:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      note_xh_30:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      note_jd_15:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      note_jd_30:   { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      cr_base:     { status: 'pass', actual: 25, expect: 25, ts: '2026-02-07' },
      cr_offline:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      cr_realtime: { status: 'pass', actual: 0, expect: 0, ts: '2026-02-08' },
      cr_conv_xh:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      cr_conv_jd:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      kw_base:     { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      kw_realtime: { status: 'pass', actual: 0, expect: 0, ts: '2026-02-08' },
      kw_offline:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      sw_offline:  { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      tg_target_base:     { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      tg_target_realtime: { status: 'pass', actual: 0, expect: 0, ts: '2026-02-08' },
      tg_audience:        { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      rp_base:     { status: 'pass', actual: 95, expect: 95, ts: '2026-02-07' },
      rp_xh:       { status: 'pass', actual: 65, expect: 65, ts: '2026-02-07' },
      rp_jd:       { status: 'pass', actual: 30, expect: 30, ts: '2026-02-07' },
      ac_base:     { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      ac_daily:    { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      tg_base:     { status: 'pass', actual: 0, expect: 0, ts: '2026-02-07' },
      tg_xh_15:       { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      tg_xh_30:       { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      tg_jd_15:       { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
      tg_jd_30:       { status: 'pass', actual: 0, expect: 0, ts: '2026-02-06' },
    }
  }
];

// ─── Helpers ───
const sIcon = { pass: 'check_circle', fail: 'error' };
const sLabel = { pass: 'PASS', fail: 'FAIL' };
function badgeHTML(status) { const s = status === 'pending' ? 'fail' : status; return `<span class="badge ${s}"><span class="icon">${sIcon[s]}</span>${sLabel[s]}</span>`; }

// 基准项只显示单数，非基准显示 actual / expect
function countHTML(actual, expect, isBase) {
  if (isBase) return `<div class="cat-item-count"><span class="actual">${actual.toLocaleString()}</span></div>`;
  const mm = actual !== expect;
  return `<div class="cat-item-count ${mm ? 'mismatch' : ''}"><span class="actual">${actual.toLocaleString()}</span><span class="sep">/</span><span class="expect">${expect.toLocaleString()}</span></div>`;
}

function summarize(project) {
  let t = 0, p = 0, f = 0;
  Object.values(CHECKS).forEach(group => {
    group.items.forEach(item => {
      if (item.id.endsWith('_base')) return;
      t++;
      const c = project.checks[item.id];
      if (c && c.status === 'pass') p++; else f++;
    });
  });
  return { total: t, pass: p, fail: f };
}

function globalSummary() {
  let t = 0, p = 0, f = 0;
  Object.values(CHECKS).forEach(group => {
    group.items.forEach(item => {
      if (item.id.endsWith('_base')) return;
      t++;
      let worst = 'pass';
      PROJECTS.forEach(pr => {
        const c = pr.checks[item.id];
        if (c.status === 'fail') worst = 'fail';
        else if (c.status === 'pending' && worst !== 'fail') worst = 'pending';
      });
      if (worst === 'pass') p++; else f++;
    });
  });
  return { total: t, pass: p, fail: f };
}

function projectStatus(pr) {
  const s = summarize(pr);
  return s.fail > 0 ? 'fail' : 'pass';
}

// ─── State ───
let selected = '__all__';

// 默认业务日期 = 今天
function fmtDate(d) { const p = v => String(v).padStart(2, '0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
let bizDateSelected = fmtDate(new Date());

// 根据业务日期和 lag 计算实际数据日期
function dataDate(bizDt, lag) {
  if (lag == null) return bizDt;
  const d = new Date(bizDt); d.setDate(d.getDate() - lag);
  return fmtDate(d);
}

function toolbarHTML() {
  const d0 = bizDateSelected;                    // 实时：当日
  const d1 = dataDate(bizDateSelected, 1);       // 离线：T-1
  const d2 = dataDate(bizDateSelected, 2);       // 转化：T-2
  return `<div class="toolbar">
    <span class="toolbar-label">核验日期</span>
    <input type="date" class="toolbar-date" id="bizDate" value="${d0}">
    <div class="toolbar-sep"></div>
    <span class="toolbar-label">业务日期</span>
    <div class="toolbar-lag">
      <div class="lag-chip"><span class="lag-dot realtime"></span>实时 <span class="lag-date">T</span></div>
      <div class="lag-chip"><span class="lag-dot offline"></span>离线 <span class="lag-date">T-1</span></div>
      <div class="lag-chip"><span class="lag-dot convert"></span>转化 <span class="lag-date">T-2</span></div>
    </div>
  </div>`;
}

// ─── Sidebar ───
function renderSidebar() {
  const el = document.getElementById('sidebar');
  let h = `<div class="sidebar-section">PROJECT</div>`;
  h += `<div class="sidebar-item ${selected === '__all__' ? 'active' : ''}" data-id="__all__"><span class="s-name">全部</span><span class="s-count">${PROJECTS.length}</span></div>`;
  h += `<div class="sidebar-gap"></div>`;
  PROJECTS.forEach(p => {
    const st = projectStatus(p), s = summarize(p);
    const issues = s.fail;
    h += `<div class="sidebar-item ${selected === p.id ? 'active' : ''}" data-id="${p.id}"><span class="s-dot ${st}"></span><span class="s-name">${p.name}</span>${issues > 0 ? `<span class="s-count warn">${issues}</span>` : ''}</div>`;
  });
  el.innerHTML = h;
  el.querySelectorAll('.sidebar-item').forEach(item => item.addEventListener('click', () => { selected = item.dataset.id; renderSidebar(); renderMain(); }));
}

// ─── Main ───
function renderMain() {
  const el = document.getElementById('main');
  let content = toolbarHTML();
  const tmp = document.createElement('div');
  if (selected === '__all__') { renderAllContent(tmp); } else { renderProjectContent(tmp, PROJECTS.find(p => p.id === selected)); }
  el.innerHTML = content + tmp.innerHTML;
  const dateInput = document.getElementById('bizDate');
  if (dateInput) dateInput.addEventListener('change', e => { bizDateSelected = e.target.value; renderMain(); });
}

function statsHTML(s) {
  return `<div class="stats">
    <div class="stat-card total"><div class="stat-label">检查总数</div><div class="stat-num total">${s.total}</div></div>
    <div class="stat-card pass"><div class="stat-label">通过</div><div class="stat-num pass">${s.pass}</div></div>
    <div class="stat-card fail"><div class="stat-label">异常</div><div class="stat-num fail">${s.fail}</div></div>
  </div>`;
}

function renderAllContent(el) {
  const s = globalSummary();
  let h = statsHTML(s);

  h += `<div class="cat-grid">`;
  Object.entries(CHECKS).forEach(([key, group]) => {
    let gp = 0, gf = 0, gw = 0;
    group.items.forEach(item => PROJECTS.forEach(pr => { const c = pr.checks[item.id]; if (c.status === 'pass') gp++; else if (c.status === 'fail') gf++; else gw++; }));

    h += `<div class="cat-card" style="animation-delay:${0.08}s">
      <div class="cat-head">
        <div class="cat-head-left">
          <div class="cat-icon ${key}"><span class="icon">${group.icon}</span></div>
          <span class="cat-title">${group.label}</span>
        </div>
      </div>
      <div class="cat-body">
        ${(() => { let lastG = null; return group.items.map(item => {
          let ta = 0, te = 0, worst = 'pass', latestTs = null;
          const isBase = item.id.endsWith('_base');
          PROJECTS.forEach(pr => { const c = pr.checks[item.id]; ta += c.actual; te += c.expect; if (c.status === 'fail') worst = 'fail'; else if (c.status === 'pending' && worst !== 'fail') worst = 'pending'; if (c.ts && (!latestTs || c.ts > latestTs)) latestTs = c.ts; });
          const tsShort = latestTs ? latestTs.slice(5) : '-';
          let prefix = '';
          if (item.group && item.group !== lastG) { prefix = `<div class="cat-subgroup"><span>${item.group}</span>${item.groupTotal ? `<span class="cat-subgroup-total">共 ${item.groupTotal}</span>` : ''}</div>`; lastG = item.group; }
          const hasGroup = !!item.group;
          if (isBase) {
            const bsPrefix = group.baseSourceType === 'derived' ? '推导自' : '来源于';
            const baseRight = group.baseSource
              ? `<span class="cat-base-source">${bsPrefix}「${group.baseSource}」</span>`
              : `<span class="cat-base-ts">${tsShort}</span><span class="badge ${worst}"><span class="icon">${sIcon[worst]}</span>${sLabel[worst]}</span>`;
            let baseNumsHtml;
            if (group.baseValues?.v1 !== undefined) {
              baseNumsHtml = `<div class="cat-base-nums">
                <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.l1}</span><span class="cat-base-stat-num">${group.baseValues.v1}</span></div>
                <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.l2}</span><span class="cat-base-stat-num">${group.baseValues.v2}</span></div>
                <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.l3}</span><span class="cat-base-stat-num">${group.baseValues.v3}</span></div>
              </div>`;
            } else if (group.baseValues) {
              if (group.baseValues.active !== undefined) {
                baseNumsHtml = `<div class="cat-base-nums">
                  <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.first || '总数'}</span><span class="cat-base-stat-num">${group.baseValues.total}</span></div>
                  <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.second || '有效'}</span><span class="cat-base-stat-num active">${group.baseValues.active}</span></div>
                </div>`;
              } else {
                baseNumsHtml = `<div class="cat-base-nums">
                  <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.first || '总数'}</span><span class="cat-base-stat-num">${group.baseValues.total}</span></div>
                </div>`;
              }
            } else {
              baseNumsHtml = `<span class="cat-base-num">${ta.toLocaleString()}</span>`;
            }
            return prefix + `<div class="cat-base">
              <div class="cat-base-left"><span class="cat-base-label">数据基准</span>${baseNumsHtml}</div>
              <div class="cat-base-right">${baseRight}</div>
            </div>`;
          }
          return prefix + `<div class="cat-item${hasGroup ? ' indent' : ''}">
            <span class="cat-item-name">${item.name}${item.tag ? `<span class="cat-item-tag">${item.tag}</span>` : ''}</span>
            ${countHTML(ta, te, false)}
            <span class="cat-item-ts">${tsShort}</span>
            <div class="cat-item-status">${badgeHTML(worst)}</div>
          </div>`;
        }).join(''); })()}
      </div>
    </div>`;
  });
  h += `</div>`;
  el.innerHTML = h;
}

function renderProjectContent(el, project) {
  if (!project) return;
  const s = summarize(project);
  let h = statsHTML(s);

  h += `<div class="cat-grid">`;
  Object.entries(CHECKS).forEach(([key, group]) => {
    const items = group.items.map(i => ({ ...i, ...project.checks[i.id] }));
    const gp = items.filter(c => c.status === 'pass').length;
    const gf = items.filter(c => c.status === 'fail').length;
    const gw = items.filter(c => c.status === 'pending').length;

    h += `<div class="cat-card" style="animation-delay:0.08s">
      <div class="cat-head">
        <div class="cat-head-left">
          <div class="cat-icon ${key}"><span class="icon">${group.icon}</span></div>
          <span class="cat-title">${group.label}</span>
        </div>
      </div>
      <div class="cat-body">
        ${(() => { let lastG = null; return items.map(c => {
          const isBase = c.id.endsWith('_base');
          const tsDisplay = c.ts ? c.ts.slice(5) : '-';
          let prefix = '';
          if (c.group && c.group !== lastG) { prefix = `<div class="cat-subgroup"><span>${c.group}</span>${c.groupTotal ? `<span class="cat-subgroup-total">共 ${c.groupTotal}</span>` : ''}</div>`; lastG = c.group; }
          const hasGroup = !!c.group;
          if (isBase) {
            const baseRight = group.baseSource
              ? `<span class="cat-base-source">来源于「${group.baseSource}」</span>`
              : `<span class="cat-base-ts">${tsDisplay}</span><span class="badge ${c.status}"><span class="icon">${sIcon[c.status]}</span>${sLabel[c.status]}</span>`;
            let baseNumsHtml;
            if (group.baseValues?.v1 !== undefined) {
              baseNumsHtml = `<div class="cat-base-nums">
                <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.l1}</span><span class="cat-base-stat-num">${group.baseValues.v1}</span></div>
                <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.l2}</span><span class="cat-base-stat-num">${group.baseValues.v2}</span></div>
                <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.l3}</span><span class="cat-base-stat-num">${group.baseValues.v3}</span></div>
              </div>`;
            } else if (group.baseValues) {
              if (group.baseValues.active !== undefined) {
                baseNumsHtml = `<div class="cat-base-nums">
                  <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.first || '总数'}</span><span class="cat-base-stat-num">${group.baseValues.total}</span></div>
                  <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.second || '有效'}</span><span class="cat-base-stat-num active">${group.baseValues.active}</span></div>
                </div>`;
              } else {
                baseNumsHtml = `<div class="cat-base-nums">
                  <div class="cat-base-stat"><span class="cat-base-stat-label">${group.baseLabels?.first || '总数'}</span><span class="cat-base-stat-num">${group.baseValues.total}</span></div>
                </div>`;
              }
            } else {
              baseNumsHtml = `<span class="cat-base-num">${c.actual.toLocaleString()}</span>`;
            }
            return prefix + `<div class="cat-base">
              <div class="cat-base-left"><span class="cat-base-label">数据基准</span>${baseNumsHtml}</div>
              <div class="cat-base-right">${baseRight}</div>
            </div>`;
          }
          return prefix + `<div class="cat-item${hasGroup ? ' indent' : ''}">
            <span class="cat-item-name">${c.name}${c.tag ? `<span class="cat-item-tag">${c.tag}</span>` : ''}</span>
            ${countHTML(c.actual, c.expect, false)}
            <span class="cat-item-ts">${tsDisplay}</span>
            <div class="cat-item-status">${badgeHTML(c.status)}</div>
          </div>`;
        }).join(''); })()}
      </div>
    </div>`;
  });
  h += `</div>`;
  el.innerHTML = h;
}

// ─── Clock ───
function tick() {
  const n = new Date(), p = v => String(v).padStart(2, '0');
  document.getElementById('clock').textContent = `${n.getFullYear()}-${p(n.getMonth()+1)}-${p(n.getDate())} ${p(n.getHours())}:${p(n.getMinutes())}:${p(n.getSeconds())}`;
}

renderSidebar(); renderMain(); tick(); setInterval(tick, 1000);
</script>
</body>
</html>
